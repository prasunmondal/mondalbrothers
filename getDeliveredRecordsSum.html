<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delivered KG Report</title>
    <script>
        async function fetchData() {
            const apiUrl = 'https://script.google.com/macros/s/AKfycby0rORN4PWBqs2XR2JFTlMHBA2kphA7A8LLrAQ40yF8aiXveEa1cqUJA-glH36VdRZ0Pg/exec';
            const formData = new FormData();
            formData.append('operations', '[{"opCode":"FETCH_ALL","sheetId":"1VYrAZxWXE4bNA6HjoBWbGS17rQxaMgjvnrIUzopnHdY","tabName":"apiData","opId":"04912489-167e-4048-813f-8a14ea48f6c5-1737648761099"}]');
            
            const response = await fetch(apiUrl, { method: 'POST', body: formData });
            const data = await response.json();
            return data[0].content;
        }

        function processData(data, selectedDates) {
            let tableData = {};
            let columnTotals = {};

            data.forEach(row => {
                let date = new Date(row.timestamp).toLocaleDateString('en-US');
                if (!selectedDates.includes(date)) return;

                let name = row.name;
                let deliveredKg = parseFloat(row.deliveredKg).toFixed(3);
                
                if (!tableData[name]) tableData[name] = {};
                if (!tableData[name][date]) tableData[name][date] = 0;
                tableData[name][date] += parseFloat(deliveredKg);

                if (!columnTotals[date]) columnTotals[date] = 0;
                columnTotals[date] += parseFloat(deliveredKg);
            });

            return { tableData, columnTotals };
        }

        function renderTable(tableData, columnTotals, selectedDates) {
            let table = '<table border="1"><tr><th>Name</th>';
            selectedDates.forEach(date => table += `<th>${date}</th>`);
            table += '<th>Row Total</th></tr>';

            let grandTotal = 0;
            for (let name in tableData) {
                let rowTotal = 0;
                table += `<tr><td>${name}</td>`;
                selectedDates.forEach(date => {
                    let value = tableData[name][date] ? tableData[name][date].toFixed(3) : '0.000';
                    rowTotal += parseFloat(value);
                    table += `<td>${value}</td>`;
                });
                grandTotal += rowTotal;
                table += `<td>${rowTotal.toFixed(3)}</td></tr>`;
            }

            table += '<tr><th>Total</th>';
            selectedDates.forEach(date => {
                table += `<th>${(columnTotals[date] || 0).toFixed(3)}</th>`;
            });
            table += `<th>${grandTotal.toFixed(3)}</th></tr>`;
            table += '</table>';

            document.getElementById('report').innerHTML = table;
        }

        async function generateReport() {
            let selectedDates = document.getElementById('dateInput').value.split(',').map(date => new Date(date.trim()).toLocaleDateString('en-US'));
            let data = await fetchData();
            let { tableData, columnTotals } = processData(data, selectedDates);
            renderTable(tableData, columnTotals, selectedDates);
        }
    </script>
</head>
<body>
    <h2>Delivered KG Report</h2>
    <label for="dateInput">Enter dates (comma-separated, MM/DD/YYYY format): </label>
    <input type="text" id="dateInput">
    <button onclick="generateReport()">Generate Report</button>
    <div id="report"></div>
</body>
</html>
