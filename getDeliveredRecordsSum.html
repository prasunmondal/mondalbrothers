<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delivered KG Report</title>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const apiUrl = 'https://script.google.com/macros/s/AKfycby0rORN4PWBqs2XR2JFTlMHBA2kphA7A8LLrAQ40yF8aiXveEa1cqUJA-glH36VdRZ0Pg/exec';
            
            document.getElementById("fetchData").addEventListener("click", fetchData);

            function fetchData() {
                const selectedDates = Array.from(document.querySelectorAll(".date-input"))
                    .map(input => input.value).filter(date => date);
                
                if (selectedDates.length === 0) {
                    alert("Please select at least one date");
                    return;
                }
                
                fetch(apiUrl, {
                    method: 'POST',
                    body: new FormData()
                })
                .then(response => response.json())
                .then(data => processData(data, selectedDates))
                .catch(error => console.error('Error fetching data:', error));
            }

            function processData(data, selectedDates) {
                const formattedDates = selectedDates.map(date => {
                    const [year, month, day] = date.split('-');
                    return `${parseInt(month)}/${parseInt(day)}/${year}`;
                });
                
                const convertedDates = selectedDates.map(date => {
                    const istDate = new Date(`${date}T00:00:00Z`);
                    return istDate.toISOString().split('T')[0];
                });
                
                const records = data[0].content.filter(record => {
                    const recordDate = new Date(record.timestamp);
                    const istDate = new Date(recordDate.getTime() + (5.5 * 60 * 60 * 1000));
                    const formattedRecordDate = istDate.toISOString().split('T')[0];
                    return convertedDates.includes(formattedRecordDate);
                });

                let report = {};
                let dates = new Set();
                
                records.forEach(record => {
                    const recordDate = new Date(record.timestamp);
                    const istDate = new Date(recordDate.getTime() + (5.5 * 60 * 60 * 1000));
                    const formattedRecordDate = istDate.toISOString().split('T')[0];
                    
                    if (!report[record.name]) {
                        report[record.name] = {};
                    }
                    report[record.name][formattedRecordDate] = (report[record.name][formattedRecordDate] || 0) + parseFloat(record.deliveredKg.toFixed(3));
                    dates.add(formattedRecordDate);
                });
                
                renderTable(report, Array.from(dates).sort());
            }

            function renderTable(report, dates) {
                let table = `<table border="1"><tr><th>Customer</th>`;
                dates.forEach(date => table += `<th>${date}</th>`);
                table += `<th>Total</th></tr>`;

                let columnSums = {};
                dates.forEach(date => columnSums[date] = 0);
                let grandTotal = 0;
                
                for (let customer in report) {
                    let rowTotal = 0;
                    table += `<tr><td>${customer}</td>`;
                    dates.forEach(date => {
                        let value = report[customer][date] || 0;
                        table += `<td>${value.toFixed(3)}</td>`;
                        rowTotal += value;
                        columnSums[date] += value;
                    });
                    table += `<td>${rowTotal.toFixed(3)}</td></tr>`;
                    grandTotal += rowTotal;
                }
                
                table += `<tr><td><b>Total</b></td>`;
                dates.forEach(date => table += `<td><b>${columnSums[date].toFixed(3)}</b></td>`);
                table += `<td><b>${grandTotal.toFixed(3)}</b></td></tr>`;
                
                table += `</table>`;
                document.getElementById("report").innerHTML = table;
            }
        });
    </script>
</head>
<body>
    <h2>Delivered KG Report</h2>
    <label>Select Date(s): </label>
    <input type="date" class="date-input">
    <button onclick="document.body.insertBefore(document.createElement('input'), document.getElementById('fetchData')).setAttribute('type', 'date');" >Add Date</button>
    <button id="fetchData">Fetch Data</button>
    <div id="report"></div>
</body>
</html>
